<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gruppo FIDAS adsp - Prenotazioni</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    
    <header class="global-header">
        <div class="header-content">
            <img src="logofidas.png" alt="Logo FIDAS" class="header-logo">
            <span class="header-text">Gruppo FIDAS adsp di San Giusto Canavese</span>
        </div>
    </header>

    <div id="app" class="container" :class="view"> 
        
        <div v-if="view==='landing'">
            <h1 class="main-title">PrenotaQui</h1>
            <h2>Benvenuto nella nostra Applicazione per le prenotazioni</h2>
            <p>&nbsp;&nbsp;&nbsp;</p>
            <hr>
            <h3>INFORMATIVA SULLA GESTIONE DEI DATI PERSONALI DEI DONATORI:</h3>
            
            <p class="privacy-text">Ai sensi del Regolamento (UE) 2016/679 (GDPR), informiamo che i dati personali inseriti nel presente modulo di prenotazione sono trattati esclusivamente per finalità organizzative legate alla donazione di sangue. Il trattamento è svolto da persone autorizzate dal Presidente del Gruppo FIDAS San Giusto, Titolare del trattamento, nell'ambito delle attività associative e in conformità all'informativa sottoscritta dal donatore al momento dell'iscrizione alla FIDAS. I dati raccolti non saranno utilizzati per altri scopi e non saranno comunicati a soggetti terzi, salvo obblighi di legge. Il trattamento avviene nel rispetto delle misure di sicurezza previste dalla normativa vigente. Per ulteriori informazioni sul trattamento dei dati, è possibile consultare l'Informativa Privacy FIDAS disponibile presso la sede o richiederne copia al momento della donazione.</p>
            
            <h4>Prenotandoti, DICHIARI di aver preso visione di questa formativa.</h4>
            <hr>           
            <div class="landing-buttons">
                <button @click="view='auth'">Accedi</button>
                <button @click="view='register'">Registrati</button>
            </div>
        </div>

        <div v-else-if="view==='auth' || view==='register'">
            <h1 class="main-title">Inserisci le tue credenziali</h1>
            <h2></h2>
            <text></text>
            <h5>Si prega di compilare tutti i campi richiesti. L'omissione della compilazione, anche solo di uno, impedisce l'accesso al programma.</h5>
            <div class="form-container">
                <input type="text" v-model="user.lastName" placeholder="Cognome" required
                  @keydown.tab.prevent="focusNext($event)"
                  @keydown.arrow-down.prevent="focusNext($event)">
                <input type="text" v-model="user.firstName" placeholder="Nome" required
                  @keydown.tab.prevent="focusNext($event)"
                  @keydown.arrow-down.prevent="focusNext($event)">
                <input type="text" v-model="user.matricola" placeholder="Matricola" required
                  @keydown.tab.prevent="focusNext($event)"
                  @keydown.arrow-down.prevent="focusNext($event)">
                <input type="email" v-model="user.email" placeholder="E-mail" required
                  @keydown.tab.prevent="focusNext($event)"
                  @keydown.arrow-down.prevent="focusNext($event)">
                <input type="password" v-model="user.password" placeholder="Password" required
                  @keydown.tab.prevent="focusNext($event)"
                  @keydown.arrow-down.prevent="focusNext($event)">
            </div>
            <p>&nbsp;&nbsp;&nbsp;</p>
            <button @click="view='landing'">Indietro</button>
            <button @click="view==='register'? register(): login()">Avanti</button>
        </div>

        <div v-else-if="view==='pageSelect'">
            <h1 class="main-title">Seleziona una pagina</h1>
            <nav class="top-nav">
                <div></div>
                <div>
                    <button @click="adminLogin()">Area Riservata</button>
                    <button class="exit" @click="logout()">Esci</button>
                </div>
            </nav>
            <label class="page-select-label">Scegli quando Donare e verifica la disponibilità:
                <select v-model="user.pageChoice">
                    <option v-for="(name, key) in pageNames" :key="key" :value="key">
                        {{ name }}
                    </option>
                </select>
            </label>
            <p>&nbsp;&nbsp;&nbsp;</p>
            
            <button @click="view='auth'">Indietro</button>
            <button @click="enterPage()">Avanti</button>
            <h3></h3>
            <p></p>

            <div v-if="isAdmin" class="admin-settings">
                
                <div class="admin-section-header">
                    <h3>Gestione Pagine</h3>
                    <button class="admin-exit" @click="exitAdmin()">Esci Area Riservata</button>
                </div>
                
                <label>Aggiungi Nuova Pagina:</label>
                <input type="text" v-model="newPageName" placeholder="Nome nuova pagina (es. Gennaio)">
                <button @click="addPage()">Aggiungi Pagina</button>
                <p>&nbsp;&nbsp;&nbsp;</p>
                <hr>
                
                <h3>Rinomina Pagine</h3>
                <div v-for="(name, key, index) in pageNames" :key="key" class="page-management-row">
                    <label>Pagina {{ index + 1 }}:</label>
                    <input class="page-name-input" :value="name" @change="e => updatePageName(key, e.target.value)">
                    <button v-if="Object.keys(pageNames).length > 1" @click="removePage(key)" class="reset">Rimuovi</button>
                </div>               
                <p>&nbsp;&nbsp;&nbsp;</p>
                <hr>
                <hr>

                <h3>Blocca Prenotazioni</h3>
                <div v-for="(name, key) in pageNames" :key="key">
                    <label><input type="checkbox" v-model="blocks[key]" @change="updateBlock(key)"> Blocca: {{ name }}</label>
                </div>
                <p>&nbsp;&nbsp;&nbsp;</p>
                <hr>
                <hr>

                <h3>Modifica Testi</h3>
                <label>I Pagina:</label>
                <input class="text-input" v-model="texts.landing" @change="updateText('landing')">
                <label>Pagina della selezione pagine:</label>
                <input class="text-input" v-model="texts.pageSelect" @change="updateText('pageSelect')">
                <p>&nbsp;&nbsp;&nbsp;</p>
                <hr>
                <hr>
                
                <h3>Numero Posti per Fascia Oraria</h3>
                <label>Posti disponibili per ogni fascia (escluse Riserve):</label>
                <input type="number" v-model.number="seatsPerSlot" @change="updateSeatsPerSlot()" 
                       min="1" max="20" placeholder="Numero posti (es. 6)">
                <small style="display:block; margin-top:5px; color:#666;">Valore attuale: {{ seatsPerSlot }} posti per fascia</small>
                <p>&nbsp;&nbsp;&nbsp;</p>
                <hr>
                <hr>

                <h3>Modifica password admin</h3>
                <input type="password" v-model="adminPass" @change="updateAdminPass()" placeholder="Nuova password admin">
            </div>
        </div>

        <div v-else-if="Object.keys(pageNames).includes(view)"> 
            <h1 class="main-title">Pagina prenotazione</h1>
            <nav class="top-nav">
                <div></div>
                <div>
                    <button @click="view='pageSelect'">Indietro</button> 
                    <button v-if="!isAdmin" @click="adminLogin()">Area Riservata</button>
                    <button class="exit" @click="logout()">Esci</button>
                </div>
            </nav>
            <h2 contenteditable="true" @blur="updatePageName(view, $event.target.innerText)" class="session-title">{{ pageNames[view] }}</h2>
            
            <div class="booking-section">
                <button v-if="isAdmin" class="admin-exit" @click="exitAdmin()">Esci Area Riservata</button>
                
                <div v-if="!isAdmin" class="user-booking-info">
                    <input type="text" :value="user.matricola + ' ' + user.lastName + ' ' + user.firstName" disabled>
                </div>
                <div v-else class="admin-booking-fields">
                    <input type="text" v-model="booking.matricola" placeholder="Matricola">
                    <input type="text" v-model="booking.name" placeholder="Cognome Nome">
                </div>

                <select v-model.number="booking.slot" class="slot-select">
                    <option :value="null">Seleziona fascia</option>
                    <option v-for="slot in slots" :key="slot.id" :value="slot.id">
                        {{ slot.id===8 ? 'Riserve' : slot.label }} – {{ remaining(slot) }} posti
                    </option>
                </select>
                <p>&nbsp;&nbsp;</p>
                
                <button @click="confirmBook()">Prenota</button>
            </div>
            <p>&nbsp;&nbsp;&nbsp;</p>
             
            <div v-if="isAdmin" class="admin-actions">
                <button class="reset" @click="resetAll()">Resetta Tutto</button>
                <button @click="exportExcel()">Scarica Excel</button>
                <button @click="importExcel()">Carica Excel</button>
                <input type="file" ref="fileInput" @change="handleFileUpload" style="display:none" />
            </div>

            <table class="bookings-table">
                <thead>
                    <tr><th>Ora</th><th>N.</th><th>Prenotazioni</th><th>Posti</th></tr>
                </thead>
                <tbody>
                    <tr v-for="slot in slots" :key="slot.id">
                        <td>{{ slot.id===8 ? 'Riserve' : 'Fascia: ' + slot.label }}</td>
                        <td><div v-for="j in seatsPerSlot" :key="j">{{ slot.id*seatsPerSlot + j }}</div></td>
                        <td>
                            <div v-for="b of bookingsBySlot[slot.id]" :key="b.key" class="prenotazione-nome">
                                <span>{{ b.matricola }} {{ isAdmin ? b.name : mask(b.name, b.matricola) }}</span>
                                <button v-if="isAdmin" @click="removeBooking(b.key)">Cancella</button>
                            </div>
                        </td>
                        <td>{{ remaining(slot) }} posti</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- MODALE PERSONALIZZATO -->
        <div v-if="modal.show" class="modal-overlay" @click.self="modalCancel">
            <div class="modal-box">
                <h3 class="modal-title">{{ modal.title }}</h3>
                <p class="modal-message">{{ modal.message }}</p>
                <input v-if="modal.type === 'prompt'" v-model="modal.input" type="text" class="modal-input" @keyup.enter="modalConfirm" placeholder="Inserisci...">
                <div class="modal-buttons">
                    <button v-if="modal.type !== 'alert'" @click="modalCancel" class="modal-btn-cancel">Annulla</button>
                    <button @click="modalConfirm" class="modal-btn-ok">{{ modal.type === 'alert' ? 'OK' : 'Conferma' }}</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module" src="app.js"></script>
</body>
</html>
